service: lecshare-api
custom:
  # Object Storage Bucket Names
  generalBucket: assets-lecshare.oimo.ca
  processingBucket: lecshare-audio-processing
  transcriptionBucket: lecshare-transcriptions
  # try to use the argument, then the provider stage
  stage: ${opt:stage, self:provider.stage}
  tableName: lecshare-api-${self:custom.stage}
   # Pub / Sub Topic Names
  startMediaEncoderTopicName: lecshare-start-media-encoder-${self:custom.stage}
  finishMediaEncoderTopicName: lecshare-finish-media-encoder-${self:custom.stage}
  # Custom Domain
  customDomain:
    # TODO change over to vikelabs.ca
    domainName: dev.oimo.ca
    basePath: lecshare
    stage: ${self:custom.stage}
    # TODO change over to api.oimo.ca (or api.vikelabs.ca)
    certificateName: 'dev.oimo.ca'
    endpointType: regional
    securityPolicy: tls_1_2
    createRoute53Record: false
provider:
  name: aws
  region: us-west-2 # oregon
  # default memory for size for all Lambda functions unless specified.
  memorySize: 512
  runtime: go1.x
  # stage: production
  environment:
    TABLE_NAME: ${self:custom.tableName}
    BUCKET_NAME: ${self:custom.generalBucket}
    BUCKET_NAME_CDN: "https://cdn.lecshare.vikelabs.ca"
    PROCESSING_BUCKET_NAME: ${self:custom.processingBucket}
  iamRoleStatements:
  - Effect: Allow
    Action:
      - dynamodb:DescribeTable
      - dynamodb:Query
      - dynamodb:Scan
      - dynamodb:GetItem
      - dynamodb:PutItem
      - dynamodb:UpdateItem
      - dynamodb:DeleteItem
    # Restrict our IAM role permissions to
    # the specific table for the stage
    Resource:
      - "Fn::GetAtt": [ LecshareTable, Arn ]
  - Effect: Allow
    Action:
      - s3:GetObject
      - s3:PutObject
    Resource: "arn:aws:s3:::${self:custom.generalBucket}/*"
  - Effect: Allow
    Action:
      - s3:GetObject
      - s3:PutObject
    Resource: "arn:aws:s3:::${self:custom.processingBucket}/*"
  - Effect: Allow
    Action:
      - s3:GetObject
      - s3:PutObject
      - s3:DeleteObject
    Resource: "arn:aws:s3:::${self:custom.transcriptionBucket}/*"
  - Effect: Allow
    Action:
      - sns:Publish
      - sns:Subscribe 
    Resource: "arn:aws:sns:::${self:custom.startMediaEncoderTopicName}"
  - Effect: Allow
    Action:
      - sns:Publish
      - sns:Subscribe 
    Resource: "arn:aws:sns:::${self:custom.finishMediaEncoderTopicName}"
functions:
  playground:
    description: GraphQL Playground Lambda
    handler: bin/playground
    events:
      - http:
          path: /
          method: get
          cors: true
      - http:
          path: /
          method: post
          cors: true
  graphql:
    description: GraphQL Endpoint
    handler: bin/graph
    events:
      - http:
          path: /query
          method: get
          cors: true
      - http:
          path: /query
          method: post
          cors: true
  convert-audio:
    description: Converts Lecture Audio
    handler: bin/convert-audio
    memorySize: 1024
    events:
      - s3:
        bucket: ${self:custom.processingBucket}
        existing: true
        event: s3:ObjectCreated:*
    layers:
      - {Ref: FfmpegLambdaLayer}
  store-transcription:
    description: Puts transcription in proper bucket and folder
    handler: bin/store-transcription
    events:
      - s3:
        bucket: ${self:custom.transcriptionBucket}
        existing: true
        event: s3:ObjectCreated:*
        rules:
          - suffix: .json
  slackbot:
    description: Subscribes to a SNS topic, outputs to a Slack webhook URL
    handler: bin/slackbot
    events:
     - sns: 
        arn:
          Fn::Join:
            - ':'
            - - 'arn:aws:sns'
              - Ref: 'AWS::Region'
              - Ref: 'AWS::AccountId'
              - ${self:custom.startMediaEncoderTopicName}
        topicName: ${self:custom.startMediaEncoderTopicName}
resources:
  Resources:
    LecshareTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableName}
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
        Tags:
          - Key: PROJECT
            Value: LECSHARE
    MediaEncoderStartTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:custom.startMediaEncoderTopicName} 
        DisplayName: "Topic for to be started media encode jobs."
        Tags:
          - Key: PROJECT
            Value: LECSHARE
    MediaEncoderFinishTopic:
      Type: AWS::SNS::Topic
      Properties: 
        TopicName: ${self:custom.finishMediaEncoderTopicName}
        DisplayName: "Topic for finished media encode jobs."
        Tags:
          - Key: PROJECT
            Value: LECSHARE
package:
  # configuration of the files required in this service.
  exclude:
    - ./**
  include:
    - ./bin/**
plugins:
  - serverless-domain-manager
layers:
  ffmpeg:
    path: layer
    package:
      include:
        - ./**